{% extends 'base.html' %}
{% load staticfiles i18n tz counter assign %}
{% localtime on %}
    {% get_current_timezone as TIME_ZONE %}
    {% if user.is_authenticated %}
        {% block title %}{% trans "Location" %} - {{ block.super }}{% endblock %}
        {% block content %}
            <div class="mym-dash">
                <div class="d-flex flex-row justify-content-start align-items-center flex-wrap">
                    <div class="mym-dash-item">
                        <div id="reportrange"
                             style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 18rem ">
                            <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                            <span id="selcdates"></span> <b class="caret"></b>
                        </div>
                    </div>
                    <div id="vpselector" class="mym-dash-item">
                        <select class="vpselectedclass" multiple="multiple" id="vpsselected" name="vpsselected">
                            {% for vpnumber in vpslist %}
                                <option id="optionvp#{{ vpnumber.vpNumber }}" value='{{ vpnumber.vpNumber }}'
                                        {% if vpnumber.vpNumber in vpsselected %}selected{% endif %}>
                                    VP#{{ vpnumber.vpNumber }} - {{ vpnumber.vpDescription }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="orgmymaccselector" class="mym-dash-item">
                        <select class="vpselectedclass" multiple="multiple" id="orgmymaccselected"
                                name="orgmymaccselected">
                            {% for orgmymacc in orgmymacclist %}
                                <option id="optionacc#{{ orgmymacc }}" value='{{ orgmymacc }}'
                                        {% if orgmymacc in orgmymaccselected %}selected{% endif %}>{{ orgmymacc }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mym-dash-item">
                        <button id="refreshbtn" type="button" class="mym-dash-item btn btn-outline-primary btn-lg"
                                data-toggle="tooltip"
                                data-placement="top" title="{% trans 'Refresh with current selection' %}">
                            <span class="fa fa-refresh"></span>
                        </button>
                    </div>
                    <div class="mym-dash-item">
                        <div class="form-check">
                            <label class="form-check-label">
                                {% if showuserpath == 1 %}
                                    <input id="showuserpath" class="form-check-input" type="checkbox" value="" checked>
                                {% else %}
                                    <input id="showuserpath" class="form-check-input" type="checkbox" value="">
                                {% endif %}
                                {% trans "Show user path" %}
                            </label>
                        </div>
                        <div class="form-check">
                            <label class="form-check-label">
                                {% if showlocationprecision == 1 %}
                                    <input id="showlocationprecision" class="form-check-input" type="checkbox" value=""
                                           checked>
                                {% else %}
                                    <input id="showlocationprecision" class="form-check-input" type="checkbox" value="">
                                {% endif %}
                                {% trans "Show location precision" %}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div id="locationview">
                <div id="locationmapid"></div>
            </div>
            <hr>
            <div id="vpsview">
                {% for vp in vps %}
                    <div class="d-flex align-content-start flex-wrap">
                        {% if vp.vpNumber in media_vpnumbers %}
                            {% for media in medias %}
                                {% if vp.vpNumber == media.mediaVpNumber %}
                                    {% if media.mediaContentType == "image/jpeg" %}
                                        <!-- Modal to Images -->
                                        <div class="modal fade"
                                             id="mediaModal{{ media.id }}"
                                             tabindex="-1" role="dialog" aria-labelledby="mediaImageModalLabel"
                                             aria-hidden="true">
                                            <div class="modal-dialog modal-xl">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <img id="mediaContent" class="img-fluid"
                                                             src="{{ media.mediaStorageURL }}" alt="">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if media.mediaContentType == "video/mp4" %}
                                        <!-- Modal to Videos -->
                                        <div class="modal fade"
                                             id="mediaModal{{ media.id }}"
                                             tabindex="-1" role="dialog" aria-labelledby="mediaVideoModalLabel"
                                             aria-hidden="true">
                                            <div class="modal-dialog modal-xl">
                                                <div class="modal-content">
                                                    <div class="modal-body">
                                                        <div class="embed-responsive embed-responsive-16by9">
                                                            <video controls>
                                                                <source src="{{ media.mediaStorageURL }}"
                                                                        type="video/mp4">
                                                            </video>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endblock %}
        {% block javascript %}
            <link rel="stylesheet" href="{% static 'css/leaflet.extra-markers.min.css' %}">
            <script src="{% static "js/leaflet.js" %}"></script>
            <script src="{% static "js/leaflet.extra-markers.min.js" %}"></script>

            <script type="text/javascript">

                console.log("{{ orgmymaccselected }}");

                $('#vpsselected').chosen();

                $('#orgmymaccselected').chosen();

                {% get_current_language as LANGUAGE_CODE %}

                moment.locale('{{ LANGUAGE_CODE }}');

                $(function () {

                    var start = moment("{{ start }}");
                    var end = moment("{{ end }}");

                    function cb(start, end) {
                        $('#reportrange span').html(start.format('YYYY-MMM-DD') + ' - ' + end.format('YYYY-MMM-DD'));
                    }

                    $('#reportrange').daterangepicker({
                        startDate: {{ start }},
                        endDate: {{ end }},
                        "alwaysShowCalendars": true,
                        {% if LANGUAGE_CODE == "pt" %}
                            ranges: {
                                'Hoje': [moment(), moment()],
                                'Ontem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                                'Últimos 7 Dias': [moment().subtract(6, 'days'), moment()],
                                'Últimos 30 Dias': [moment().subtract(29, 'days'), moment()],
                                'Este Mês': [moment().startOf('month'), moment().endOf('month')],
                                'Mês Passado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                            },
                            "locale": {
                                "format": "YYYY-MMM-DD",
                                "separator": " - ",
                                "applyLabel": "Aplicar",
                                "cancelLabel": "Cancelar",
                                "fromLabel": "De",
                                "toLabel": "a",
                                "customRangeLabel": "Personalizado",
                                "weekLabel": "S",
                                "daysOfWeek": [
                                    "Do",
                                    "2a",
                                    "3a",
                                    "4a",
                                    "5a",
                                    "6a",
                                    "Sa"
                                ],
                                "monthNames": [
                                    "Janeiro",
                                    "Fevereiro",
                                    "Março",
                                    "Abril",
                                    "Maio",
                                    "Junho",
                                    "Julho",
                                    "Agosto",
                                    "Setembro",
                                    "Outubro",
                                    "Novembro",
                                    "Dezembro"
                                ],
                                "firstDay": 1
                            }
                        {% elif LANGUAGE_CODE == "pt-br" %}
                            ranges: {
                                'Hoje': [moment(), moment()],
                                'Ontem': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                                'Últimos 7 Dias': [moment().subtract(6, 'days'), moment()],
                                'Últimos 30 Dias': [moment().subtract(29, 'days'), moment()],
                                'Este Mês': [moment().startOf('month'), moment().endOf('month')],
                                'Mês Passado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                            },
                            "locale": {
                                "format": "YYYY-MMM-DD",
                                "separator": " - ",
                                "applyLabel": "Aplicar",
                                "cancelLabel": "Cancelar",
                                "fromLabel": "De",
                                "toLabel": "a",
                                "customRangeLabel": "Personalizado",
                                "weekLabel": "S",
                                "daysOfWeek": [
                                    "Do",
                                    "2a",
                                    "3a",
                                    "4a",
                                    "5a",
                                    "6a",
                                    "Sa"
                                ],
                                "monthNames": [
                                    "Janeiro",
                                    "Fevereiro",
                                    "Março",
                                    "Abril",
                                    "Maio",
                                    "Junho",
                                    "Julho",
                                    "Agosto",
                                    "Setembro",
                                    "Outubro",
                                    "Novembro",
                                    "Dezembro"
                                ],
                                "firstDay": 1
                            }
                        {% else %}
                            ranges: {
                                'Today': [moment(), moment()],
                                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                                'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                                'This Month': [moment().startOf('month'), moment().endOf('month')],
                                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                            },
                            "locale": {
                                "format": "YYYY-MMM-DD",
                                "separator": " - ",
                                "applyLabel": "Apply",
                                "cancelLabel": "Cancel",
                                "fromLabel": "From",
                                "toLabel": "To",
                                "customRangeLabel": "Custom",
                                "weekLabel": "W",
                                "daysOfWeek": [
                                    "Su",
                                    "Mo",
                                    "Tu",
                                    "We",
                                    "Th",
                                    "Fr",
                                    "Sa"
                                ],
                                "monthNames": [
                                    "January",
                                    "February",
                                    "March",
                                    "April",
                                    "May",
                                    "June",
                                    "July",
                                    "August",
                                    "September",
                                    "October",
                                    "November",
                                    "December"
                                ],
                                "firstDay": 1
                            }
                        {% endif %}
                    }, cb);

                    cb(start, end);

                    $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
                        var startdate = picker.startDate.format('YYYY-MM-DD');
                        var enddate = picker.endDate.format('YYYY-MM-DD');
                        console.log(startdate);
                        console.log(enddate);
                        //console.log({% url 'portfolio' %});
                        var vpssel = $('#vpsselected').serialize();
                        var orgmymaccsel = $('#orgmymaccselected').serialize();
                        console.log('Chosen:' + vpssel);
                        window.location = '{% url 'location' %}' + '?startdate=' + startdate + '&enddate=' + enddate + '&showlocationprecision=' + {{ showlocationprecision }}+'&' + vpssel + '&' + orgmymaccsel;
                    });

                    $('#refreshbtn').click(function () {
                        var vpssel = $('#vpsselected').serialize();
                        var orgmymaccsel = $('#orgmymaccselected').serialize();
                        console.log('Chosen:' + vpssel);
                        console.log('Chosen:' + orgmymaccsel);
                        window.location = '{% url 'location' %}' + '?startdate=' + '{{ start }}' + '&enddate=' + '{{ end }}' + '&showlocationprecision=' + {{ showlocationprecision }} +'&' + vpssel + '&' + orgmymaccsel;
                    });

                });

                $(function () {

                    var showLocationPrecision = {{ showlocationprecision }};
                    var showUserPath = {{ showuserpath }};

                    var zoomlevel = 10;

                    var markerGroup = [];

                    var markerColor = ['blue', 'red', 'orange-dark', 'orange', 'yellow', 'blue-dark', 'cyan', 'purple', 'violet', 'pink', 'green-dark', 'green', 'green-light', 'black', 'black', 'blue', 'red', 'orange-dark', 'orange', 'yellow', 'blue-dark', 'cyan', 'purple', 'violet', 'pink', 'green-dark', 'green', 'green-light', 'black', 'blue', 'blue'];

                    var markerShape = ['circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'circle', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'square', 'star', 'penta'];

                    var mymap = L.map('locationmapid').setView([0, 0], zoomlevel);

                    $('#showlocationprecision').click(function () {
                        if ($(this).is(':checked')) {
                            showLocationPrecision = 1;
                        } else {
                            showLocationPrecision = 0;
                        }
                        var vpssel = $('#vpsselected').serialize();
                        var orgmymaccsel = $('#orgmymaccselected').serialize();
                        window.location = '{% url 'location' %}' + '?startdate=' + '{{ start }}' + '&enddate=' + '{{ end }}' + '&showlocationprecision=' + showLocationPrecision + '&showuserpath=' + {{ showuserpath }} +'&' + vpssel + '&' + orgmymaccsel;
                    });

                    $('#showuserpath').click(function () {
                        if ($(this).is(':checked')) {
                            showUserPath = 1;
                        } else {
                            showUserPath = 0;
                        }
                        var vpssel = $('#vpsselected').serialize();
                        var orgmymaccsel = $('#orgmymaccselected').serialize();
                        window.location = '{% url 'location' %}' + '?startdate=' + '{{ start }}' + '&enddate=' + '{{ end }}' + '&showlocationprecision=' + {{ showlocationprecision }} +'&showuserpath=' + showUserPath + '&' + vpssel + '&' + orgmymaccsel;
                    });

                    var colorNames = ['blue', 'red', 'orange', 'yellow', 'cyan', 'purple', 'violet', 'pink', 'green', 'black'];

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(mymap);
                    {% for orgmymacc in orgmymacclist %}
                        {% if orgmymacc in orgmymaccselected %}
                            var coords{{ orgmymacc | cut:"+" }} = [];
                        {% endif %}
                    {% endfor %}
                    {% for vp in vps %}
                        {% if vp.vpNumber in media_vpnumbers %}
                            {% for media in medias %}
                                {% if vp.vpNumber == media.mediaVpNumber %}
                                    {% if media.mediaOriginalMymensorAccount in orgmymaccselected %}
                                        {% for orgmymacc in orgmymacclist %}
                                            {% if media.mediaOriginalMymensorAccount == orgmymacc %}
                                                coords{{ orgmymacc | cut:"+" }}.push([{{ media.mediaLatitude }}, {{ media.mediaLongitude }}]);
                                            {% endif %}
                                        {% endfor %}
                                        var markericon{{ media.id }} = L.ExtraMarkers.icon({
                                            icon: 'fa-number',
                                            markerColor: markerColor[{{ media.mediaVpNumber }}],
                                            shape: markerShape[{{ media.mediaVpNumber }}],
                                            number: '{{ media.mediaVpNumber }}',
                                            prefix: 'fa'
                                        });
                                        var marker{{ media.id }} = L.marker([{{ media.mediaLatitude }}, {{ media.mediaLongitude }}], {icon: markericon{{ media.id }}}).addTo(mymap);
                                        marker{{ media.id }}.mediaid ={{ media.id }};
                                        marker{{ media.id }}.on('mouseover', function (ev) {
                                            ev.target.bindTooltip('{{ media.mediaOriginalMymensorAccount }} - VP#{{ media.mediaVpNumber }} - {{ media.mediaTimeStamp | localtime | date:"Y-b-d H:i:sO" }}').openTooltip();
                                        });
                                        marker{{ media.id }}.on('mouseout', function (ev) {
                                            ev.target.closeTooltip();
                                        });
                                        markerGroup.push(marker{{ media.id }});
                                        if (showLocationPrecision) {
                                            var circle = L.circle([{{ media.mediaLatitude }}, {{ media.mediaLongitude }}], {
                                                color: 'red',
                                                fillColor: '#f03',
                                                fillOpacity: 0.2,
                                                radius: {{ media.mediaLocPrecisionInMeters | floatformat:3 }}
                                            }).addTo(mymap);
                                        }
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}

                    if (showUserPath == 1) {
                        {% for orgmymacc in orgmymacclist %}
                            {% if orgmymacc in orgmymaccselected %}
                                var colorrand = colorNames[(Math.floor((Math.random() * 10)))];
                                console.log(colorrand);
                                var pathLine = L.polyline(coords{{ orgmymacc | cut:"+" }}, {color: colorrand}).addTo(mymap);
                            {% endif %}
                        {% endfor %}
                    }
                    var group = new L.featureGroup(markerGroup).on('click', eventCallbackHandler);
                    mymap.fitBounds(group.getBounds());
                    function eventCallbackHandler(event) {
                        console.log(event.layer.mediaid);
                        $('#mediaModal' + event.layer.mediaid).modal('show');
                    }

                });


            </script>

        {% endblock %}
    {% else %}
        <h1>Not Logged In....</h1>
    {% endif %}
{% endlocaltime %}
