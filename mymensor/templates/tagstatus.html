{% extends 'base.html' %}
{% load i18n staticfiles %}
{% load render_table from django_tables2 %}
{% block title %}Tag Status - {{ block.super }}{% endblock %}

{% block content %}
    <div class="mym-dash">
        <div class="d-flex flex-row justify-content-start align-items-center flex-wrap">
            <div class="mym-dash-item">
                <div id="reportrange"
                     style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 18rem ">
                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                    <span id="selcdates"></span> <b class="caret"></b>
                </div>
            </div>
            <div id="qtyselector" class="mym-dash-item">
                <p>{% trans 'Show ' %}</p>
                <select id="linesperpage">
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <p>{% trans ' lines per page' %}</p>
            </div>
            <div id="tagselector" class="mym-dash-item" style="width:30rem">
                <select multiple="multiple" id="tagsselected" name="tagsselected">
                    {% for processedtagnumber in listofprocessedtagsnumbers %}
                        <option id="optiontag#{{ processedtagnumber.statusTagNumber }}"
                                value='{{ processedtagnumber.statusTagNumber }}'
                                {% if processedtagnumber.statusTagNumber in tagsselected %}selected{% endif %}>
                            Tag#{{ processedtagnumber.statusTagNumber }}
                            - {{ processedtagnumber.statusTagDescription }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mym-dash-item">
                <button id="refreshbtn" type="button" class="btn btn-outline-primary btn-lg" data-toggle="tooltip"
                        data-placement="top" title="{% trans 'Refresh chart with current selection' %}">
                    <span class="fa fa-refresh"></span>
                </button>
            </div>
            <div class="mym-dash-item">
                <button id="exprtcsvbtn" type="button" class="btn btn-outline-primary btn-lg" data-toggle="tooltip"
                        data-placement="top" title="{% trans 'Export complete table as CSV' %}">
                    <span class="fa fa-table"></span>
                </button>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-sm-10">
            {% render_table tagstatustable %}
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script type="text/javascript">
        $('#tagsselected').chosen();
        $('#linesperpage option[value="{{ linesperpage }}"]').attr('selected', 'selected');

        $(function () {

            var start = moment("{{ start }}");
            var end = moment("{{ end }}");

            console.log("{{ start }}");
            console.log("{{ end }}");
            console.log("{{ tagsselected }}");

            function cb(start, end) {
                $('#reportrange span').html(start.format('YYYY-MMM-DD') + ' - ' + end.format('YYYY-MMM-DD'));
            }

            $('#reportrange').daterangepicker({
                startDate: {{ start }},
                endDate: {{ end }},
                "alwaysShowCalendars": true,
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);

            cb(start, end);

            $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
                var startdate = picker.startDate.format('YYYY-MM-DD');
                var enddate = picker.endDate.format('YYYY-MM-DD');
                console.log(startdate);
                console.log(enddate);
                var linesperpage = $('#linesperpage').val();
                var tagssel = $('#tagsselected').serialize();
                console.log("linesperpage:" + linesperpage);
                console.log('Chosen:' + tagssel);
                window.location = {% url 'tagstatus' %}+'?startdate=' + startdate + '&enddate=' + enddate + '&linesperpage=' + linesperpage + '&' + tagssel;
            });

            $('#linesperpage').change(function () {
                var linesperpage = $('#linesperpage').val();
                var tagssel = $('#tagsselected').serialize();
                console.log("linesperpage:" + linesperpage);
                console.log('Chosen:' + tagssel);
                window.location = {% url 'tagstatus' %}+'?startdate=' + '{{ start }}' + '&enddate=' + '{{ end }}' + '&linesperpage=' + linesperpage + '&' + tagssel;
            });

            $('#refreshbtn').click(function () {
                var linesperpage = $('#linesperpage').val();
                var tagssel = $('#tagsselected').serialize();
                console.log("linesperpage:" + linesperpage);
                console.log('Chosen:' + tagssel);
                window.location = {% url 'tagstatus' %}+'?startdate=' + '{{ start }}' + '&enddate=' + '{{ end }}' + '&linesperpage=' + linesperpage + '&' + tagssel;
            });

            $('#exprtcsvbtn').click(function () {
                callexportcsvfunction({{ tagsstatustablequeryset | safe }});
            });

        });

        $(document).ready(function () {
            console.log("ready!");
            $(".statusTagStateEvaluated").filter(function () {
                if (($.trim($(this).text())) == "PROCESSED") {
                    $(this).addClass("statusprocessed");
                }
                if (($.trim($(this).text())) == "LOW RED") {
                    $(this).addClass("statuslowred");
                }
                if (($.trim($(this).text())) == "LOW YELLOW") {
                    $(this).addClass("statuslowyellow");
                }
                if (($.trim($(this).text())) == "GREEN") {
                    $(this).addClass("statusgreen");
                }
                if (($.trim($(this).text())) == "HIGH YELLOW") {
                    $(this).addClass("statushighyellow");
                }
                if (($.trim($(this).text())) == "HIGH RED") {
                    $(this).addClass("statushighred");
                }
            });
        });

        // AJAX for posting
        function callexportcsvfunction(queryset) {
            console.log("Called export CVS!"); // sanity check
            $.ajax({
                url: "export_tagstatus_csv/", // the endpoint
                type: "POST", // http method
                data: queryset, // data sent with the post request
                // handle a successful response
                success: function (json) {
                    console.log(json); // log the returned json to the console
                    console.log("success"); // another sanity check
                    location.reload();
                },
                // handle a non-successful response
                error: function (xhr, errmsg, err) {
                    //$('#results').html("<div class='alert-box alert radius' data-alert>Oops! We have encountered an error: "+errmsg+
                    //    " <a href='#' class='close'>&times;</a></div>"); // add the error to the dom
                    console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                }
            });
        }
        ;


        // This function gets cookie with a given name
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        /*
         The functions below will create a header with csrftoken
         */

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sameOrigin(url) {
            // test that a given url is a same-origin URL
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                // or any other URL that isn't scheme relative or absolute i.e relative.
                !(/^(\/\/|http:|https:).*/.test(url));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                    // Send the token to same-origin, relative URLs only.
                    // Send the token only if the method warrants CSRF protection
                    // Using the CSRFToken value acquired earlier
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

    </script>
{% endblock %}